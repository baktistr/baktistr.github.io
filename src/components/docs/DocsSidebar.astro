---
import { getCollection } from 'astro:content';

const allDocs = await getCollection('docs');
const nonDraftDocs = allDocs.filter((doc) => !doc.data.draft);

// Get current page path
const currentPath = Astro.url.pathname.replace(/\/$/, '');

// Build hierarchical structure: category -> subcategory -> docs
interface DocItem {
  title: string;
  slug: string;
  order: number;
}

interface Subcategory {
  name: string;
  index?: DocItem;
  docs: DocItem[];
}

interface Category {
  name: string;
  index?: DocItem;
  subcategories: Map<string, Subcategory>;
}

const categories = new Map<string, Category>();

// First pass: organize all docs
for (const doc of nonDraftDocs) {
  const { category, subcategory, title, order } = doc.data;

  if (!categories.has(category)) {
    categories.set(category, {
      name: category,
      subcategories: new Map(),
    });
  }

  const cat = categories.get(category)!;
  const isIndex = doc.id.endsWith('index.mdx') || doc.id.endsWith('index.md');

  if (!subcategory) {
    if (isIndex && doc.id === 'index.mdx') {
      continue;
    } else if (isIndex) {
      cat.index = { title, slug: doc.slug, order };
    } else {
      if (!cat.subcategories.has('_root')) {
        cat.subcategories.set('_root', { name: '_root', docs: [] });
      }
      cat.subcategories.get('_root')!.docs.push({ title, slug: doc.slug, order });
    }
  } else {
    if (!cat.subcategories.has(subcategory)) {
      cat.subcategories.set(subcategory, { name: subcategory, docs: [] });
    }
    const subcat = cat.subcategories.get(subcategory)!;
    if (isIndex) {
      subcat.index = { title, slug: doc.slug, order };
    } else {
      subcat.docs.push({ title, slug: doc.slug, order });
    }
  }
}

// Sort categories (Documentation first, then alphabetically)
const sortedCategories = [...categories.entries()].sort(([a], [b]) => {
  if (a === 'Documentation') return -1;
  if (b === 'Documentation') return 1;
  return a.localeCompare(b);
});

// Sort docs within each subcategory
for (const [, cat] of sortedCategories) {
  for (const [, subcat] of cat.subcategories) {
    subcat.docs.sort((a, b) => a.order - b.order);
  }
}

// Helper to check if a subcategory contains the current page
function isSubcategoryActive(subcat: Subcategory): boolean {
  if (subcat.index && currentPath === `/docs/${subcat.index.slug}`) return true;
  return subcat.docs.some((doc) => currentPath === `/docs/${doc.slug}`);
}
---

<!-- Desktop Sidebar -->
<aside class="w-64 shrink-0 hidden lg:block sticky top-20 h-[calc(100vh-5rem)] pr-4">
  <nav class="space-y-4">
    {
      sortedCategories.map(([categoryKey, category]) => (
        <div class="space-y-1">
          {category.index ? (
            <a
              href={`/docs/${category.index.slug}`}
              class="flex items-center gap-1.5 text-sm font-semibold text-slate-200 light:text-slate-800 hover:text-cyan-400 light:hover:text-cyan-600 transition-colors py-1"
            >
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              {category.name}
            </a>
          ) : (
            <span class="flex items-center gap-1.5 text-sm font-semibold text-slate-200 light:text-slate-800 py-1">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              {category.name}
            </span>
          )}

          <div class="ml-5 space-y-1">
            {[...category.subcategories.entries()]
              .filter(([key]) => key !== '_root')
              .sort(([a], [b]) => a.localeCompare(b))
              .map(([subcatKey, subcategory]) => {
                const isActive = isSubcategoryActive(subcategory);
                const hasChildren = subcategory.docs.length > 0;
                return (
                  <div class="docs-subcategory" data-subcategory={subcatKey} data-active={isActive}>
                    <div class="flex items-center">
                      <button
                        type="button"
                        class="docs-expand-btn p-0.5 -ml-1 mr-0.5 text-slate-500 hover:text-slate-300 light:hover:text-slate-700 transition-colors"
                        aria-label={`Expand ${subcategory.name}`}
                      >
                        <svg class={`w-3 h-3 transition-transform ${isActive && hasChildren ? 'rotate-90' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </button>
                      {subcategory.index ? (
                        <a
                          href={`/docs/${subcategory.index.slug}`}
                          class={`flex-1 text-sm transition-colors py-0.5 ${
                            currentPath === `/docs/${subcategory.index.slug}`
                              ? 'text-cyan-400 light:text-cyan-600'
                              : 'text-slate-300 light:text-slate-700 hover:text-cyan-400 light:hover:text-cyan-600'
                          }`}
                        >
                          {subcategory.name}
                        </a>
                      ) : (
                        <span class="flex-1 text-sm text-slate-300 light:text-slate-700 py-0.5">
                          {subcategory.name}
                        </span>
                      )}
                    </div>

                    {hasChildren && (
                      <ul class={`docs-children ml-3 mt-1 space-y-0.5 border-l border-slate-800 light:border-slate-200 pl-3 ${isActive ? '' : 'hidden'}`}>
                        {subcategory.docs.map((doc) => (
                          <li>
                            <a
                              href={`/docs/${doc.slug}`}
                              class={`block text-sm transition-colors py-0.5 ${
                                currentPath === `/docs/${doc.slug}`
                                  ? 'text-cyan-400 light:text-cyan-600'
                                  : 'text-slate-400 light:text-slate-600 hover:text-cyan-400 light:hover:text-cyan-600'
                              }`}
                            >
                              {doc.title}
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                );
              })}

            {category.subcategories.has('_root') && (
              <ul class="space-y-0.5">
                {category.subcategories.get('_root')!.docs.map((doc) => (
                  <li>
                    <a
                      href={`/docs/${doc.slug}`}
                      class={`block text-sm transition-colors py-0.5 ${
                        currentPath === `/docs/${doc.slug}`
                          ? 'text-cyan-400 light:text-cyan-600'
                          : 'text-slate-400 light:text-slate-600 hover:text-cyan-400 light:hover:text-cyan-600'
                      }`}
                    >
                      {doc.title}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      ))
    }
  </nav>
</aside>

<!-- Mobile Drawer -->
<div
  id="docs-drawer-backdrop"
  class="lg:hidden fixed inset-0 bg-black/50 light:bg-white/50 opacity-0 pointer-events-none transition-opacity"
  aria-hidden="true"
></div>

<div
  id="docs-drawer"
  class="lg:hidden fixed inset-y-0 left-0 w-80 max-w-[85vw] bg-slate-950 light:bg-white border-r border-slate-800 light:border-slate-200 z-[60] transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-full"
  role="dialog"
  aria-modal="true"
  aria-label="Docs navigation"
>
  <div class="sticky top-0 bg-slate-950 light:bg-white border-b border-slate-800 light:border-slate-200 z-10 px-4 py-3 flex items-center justify-between shrink-0">
    <h2 class="text-lg font-semibold text-slate-100 light:text-slate-900">Docs Menu</h2>
    <button
      id="docs-drawer-close"
      class="p-1 rounded-md text-slate-400 light:text-slate-600 hover:text-slate-100 light:hover:text-slate-900 hover:bg-slate-800 light:hover:bg-slate-100 transition-colors"
      aria-label="Close docs menu"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
  <nav class="p-4 space-y-4 overflow-y-auto flex-1">
    {
      sortedCategories.map(([categoryKey, category]) => (
        <div class="space-y-1">
          {category.index ? (
            <a
              href={`/docs/${category.index.slug}`}
              class="flex items-center gap-1.5 text-sm font-semibold text-slate-200 light:text-slate-800 hover:text-cyan-400 light:hover:text-cyan-600 transition-colors py-1"
            >
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              {category.name}
            </a>
          ) : (
            <span class="flex items-center gap-1.5 text-sm font-semibold text-slate-200 light:text-slate-800 py-1">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              {category.name}
            </span>
          )}

          <div class="ml-5 space-y-1">
            {[...category.subcategories.entries()]
              .filter(([key]) => key !== '_root')
              .sort(([a], [b]) => a.localeCompare(b))
              .map(([subcatKey, subcategory]) => {
                const isActive = isSubcategoryActive(subcategory);
                const hasChildren = subcategory.docs.length > 0;
                return (
                  <div class="docs-subcategory" data-subcategory={subcatKey} data-active={isActive}>
                    <div class="flex items-center">
                      <button
                        type="button"
                        class="docs-expand-btn p-0.5 -ml-1 mr-0.5 text-slate-500 hover:text-slate-300 light:hover:text-slate-700 transition-colors"
                        aria-label={`Expand ${subcategory.name}`}
                      >
                        <svg class={`w-3 h-3 transition-transform ${isActive && hasChildren ? 'rotate-90' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </button>
                      {subcategory.index ? (
                        <a
                          href={`/docs/${subcategory.index.slug}`}
                          class={`flex-1 text-sm transition-colors py-0.5 ${
                            currentPath === `/docs/${subcategory.index.slug}`
                              ? 'text-cyan-400 light:text-cyan-600'
                              : 'text-slate-300 light:text-slate-700 hover:text-cyan-400 light:hover:text-cyan-600'
                          }`}
                        >
                          {subcategory.name}
                        </a>
                      ) : (
                        <span class="flex-1 text-sm text-slate-300 light:text-slate-700 py-0.5">
                          {subcategory.name}
                        </span>
                      )}
                    </div>

                    {hasChildren && (
                      <ul class={`docs-children ml-3 mt-1 space-y-0.5 border-l border-slate-800 light:border-slate-200 pl-3 ${isActive ? '' : 'hidden'}`}>
                        {subcategory.docs.map((doc) => (
                          <li>
                            <a
                              href={`/docs/${doc.slug}`}
                              class={`block text-sm transition-colors py-0.5 ${
                                currentPath === `/docs/${doc.slug}`
                                  ? 'text-cyan-400 light:text-cyan-600'
                                  : 'text-slate-400 light:text-slate-600 hover:text-cyan-400 light:hover:text-cyan-600'
                              }`}
                            >
                              {doc.title}
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                );
              })}

            {category.subcategories.has('_root') && (
              <ul class="space-y-0.5">
                {category.subcategories.get('_root')!.docs.map((doc) => (
                  <li>
                    <a
                      href={`/docs/${doc.slug}`}
                      class={`block text-sm transition-colors py-0.5 ${
                        currentPath === `/docs/${doc.slug}`
                          ? 'text-cyan-400 light:text-cyan-600'
                          : 'text-slate-400 light:text-slate-600 hover:text-cyan-400 light:hover:text-cyan-600'
                      }`}
                    >
                      {doc.title}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      ))
    }
  </nav>
</div>

<script>
  function initExpandButtons() {
    document.querySelectorAll('.docs-expand-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const subcategory = btn.closest('.docs-subcategory');
        if (!subcategory) return;

        const children = subcategory.querySelector('.docs-children');
        const icon = btn.querySelector('svg');

        if (children) {
          children.classList.toggle('hidden');
          if (icon) {
            icon.classList.toggle('rotate-90');
          }
        }
      });
    });
  }

  initExpandButtons();
  document.addEventListener('astro:after-swap', initExpandButtons);
</script>
