---
interface Props {
  chart: string;
  class?: string;
}

const { chart, class: className = '' } = Astro.props;
const uniqueId = `mermaid-${Math.random().toString(36).substring(2, 9)}`;
---

<div class={`mermaid-container ${className}`} data-mermaid-id={uniqueId}>
  <pre class="mermaid" id={uniqueId} set:text={chart} />
</div>

<script>
  declare global {
    interface Window {
      mermaid: {
        initialize: (config: Record<string, unknown>) => void;
        run: (config?: { nodes?: NodeListOf<Element> | Element[] }) => Promise<void>;
      };
    }
  }

  async function initMermaid() {
    const containers = document.querySelectorAll('.mermaid-container:not([data-initialized])');
    if (containers.length === 0) return;

    // Load Mermaid from CDN if not already loaded
    if (typeof window.mermaid === 'undefined') {
      await new Promise<void>((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load Mermaid'));
        document.head.appendChild(script);
      });
    }

    const isDark = !document.documentElement.classList.contains('light');

    window.mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
      fontFamily: 'JetBrains Mono, monospace',
    });

    containers.forEach(container => {
      container.setAttribute('data-initialized', 'true');
    });

    await window.mermaid.run();
  }

  async function reinitMermaid() {
    const containers = document.querySelectorAll('.mermaid-container');
    if (containers.length === 0) return;

    const isDark = !document.documentElement.classList.contains('light');

    window.mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
      fontFamily: 'JetBrains Mono, monospace',
    });

    // Re-render all diagrams - need to restore original content
    const diagramsToRender: Element[] = [];
    for (const container of containers) {
      const pre = container.querySelector('.mermaid');
      if (pre) {
        const original = pre.getAttribute('data-original');
        if (original) {
          pre.textContent = original;
          pre.removeAttribute('data-mermaid-processed');
          diagramsToRender.push(pre);
        } else {
          pre.setAttribute('data-original', pre.textContent || '');
        }
      }
    }

    if (diagramsToRender.length > 0) {
      await window.mermaid.run({ nodes: diagramsToRender });
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initMermaid);
  document.addEventListener('astro:page-load', initMermaid);

  // Re-render on theme change
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class' && typeof window.mermaid !== 'undefined') {
        reinitMermaid();
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });
</script>

<style>
  .mermaid-container {
    @apply my-4 overflow-x-auto;
  }

  .mermaid {
    @apply flex justify-center p-4 rounded-lg bg-slate-900 border border-slate-800;
  }

  :global(html.light) .mermaid {
    @apply bg-slate-100 border-slate-200;
  }

  .mermaid :global(svg) {
    max-width: 100%;
    height: auto;
  }
</style>
