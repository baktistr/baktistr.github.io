---
import BaseLayout from './BaseLayout.astro';
import DocsSidebar from '../components/docs/DocsSidebar.astro';
import TableOfContents from '../components/docs/TableOfContents.astro';
import Breadcrumb from '../components/docs/Breadcrumb.astro';
import PrevNext from '../components/docs/PrevNext.astro';

interface Props {
  title: string;
  description?: string;
  headings?: Array<{ depth: number; slug: string; text: string }>;
  currentHeading?: string;
  breadcrumbs?: Array<{ name: string; href: string }>;
  prev?: { title: string; slug: string };
  next?: { title: string; slug: string };
}

const {
  title,
  description = 'Documentation',
  headings = [],
  currentHeading = '',
  breadcrumbs = [],
  prev,
  next,
} = Astro.props;
---

<BaseLayout title={`${title} | Docs`} description={description}>
  <!-- Mobile Docs Menu Toggle Button -->
  <button
    id="docs-drawer-toggle"
    class="lg:hidden fixed top-20 left-4 z-30 p-2 rounded-lg bg-slate-900 light:bg-white border border-slate-800 light:border-slate-200 text-slate-400 light:text-slate-600 hover:text-cyan-400 light:hover:text-cyan-600 hover:border-cyan-400/50 light:hover:border-cyan-600/50 transition-all shadow-lg"
    aria-label="Toggle docs menu"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </button>

  <!-- Mobile TOC Toggle Button -->
  <button
    id="toc-modal-toggle"
    class="xl:hidden fixed bottom-6 right-4 z-30 p-3 rounded-full bg-cyan-500 hover:bg-cyan-400 text-white shadow-lg hover:shadow-cyan-500/25 transition-all"
    aria-label="Toggle table of contents"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h10" />
    </svg>
  </button>

  <div class="flex gap-8">
    <DocsSidebar />
    <div class="flex-1 min-w-0 max-w-3xl">
      <Breadcrumb segments={breadcrumbs} />
      <article class="prose prose-slate">
        <slot />
      </article>
      <PrevNext prev={prev} next={next} />
    </div>
    <TableOfContents headings={headings} currentHeading={currentHeading} />
  </div>
</BaseLayout>

<script>
  // Track open overlays to manage body scroll lock
  let openOverlays = 0;

  function updateBodyScroll() {
    if (openOverlays > 0) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
  }

  // Docs Drawer functionality
  const docsDrawerToggle = document.getElementById('docs-drawer-toggle');
  const docsDrawer = document.getElementById('docs-drawer');
  const docsDrawerBackdrop = document.getElementById('docs-drawer-backdrop');
  const docsDrawerClose = document.getElementById('docs-drawer-close');

  function openDocsDrawer() {
    docsDrawer?.classList.remove('-translate-x-full');
    docsDrawerBackdrop?.classList.remove('hidden');
    openOverlays++;
    updateBodyScroll();
  }

  function closeDocsDrawer() {
    docsDrawer?.classList.add('-translate-x-full');
    docsDrawerBackdrop?.classList.add('hidden');
    openOverlays = Math.max(0, openOverlays - 1);
    updateBodyScroll();
  }

  docsDrawerToggle?.addEventListener('click', openDocsDrawer);
  docsDrawerClose?.addEventListener('click', closeDocsDrawer);
  docsDrawerBackdrop?.addEventListener('click', closeDocsDrawer);

  // TOC Modal functionality
  const tocModalToggle = document.getElementById('toc-modal-toggle');
  const tocModal = document.getElementById('toc-modal');
  const tocModalBackdrop = document.getElementById('toc-modal-backdrop');
  const tocModalClose = document.getElementById('toc-modal-close');

  function openTocModal() {
    tocModal?.classList.remove('scale-95', 'opacity-0');
    tocModal?.classList.add('scale-100', 'opacity-100');
    tocModalBackdrop?.classList.remove('hidden');
    openOverlays++;
    updateBodyScroll();
  }

  function closeTocModal() {
    tocModal?.classList.add('scale-95', 'opacity-0');
    tocModal?.classList.remove('scale-100', 'opacity-100');
    setTimeout(() => {
      tocModalBackdrop?.classList.add('hidden');
      openOverlays = Math.max(0, openOverlays - 1);
      updateBodyScroll();
    }, 150);
  }

  tocModalToggle?.addEventListener('click', openTocModal);
  tocModalClose?.addEventListener('click', closeTocModal);
  tocModalBackdrop?.addEventListener('click', closeTocModal);

  // Close drawers/modals on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeDocsDrawer();
      closeTocModal();
    }
  });
</script>
